!function(e){"use strict";var t=[300,500],n=[500,800,1e3,1e3,1e3],r=31536e3;function i(){this._portalId=null,this._correlationId=null,this._pageUrl=null,this._metadata=null,this._fpServiceUrl=null,this._bmServiceUrl=null}function o(){try{return e.self!==e.top}catch(e){return!0}}function a(){return void 0!==e.$sf&&e.$sf.ext}function c(){try{return document.cookie,!0}catch(e){return!1}}function l(){try{var e="__fp_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}function s(){var e=a(),t=!c()&&!l(),n=o();return c(),l(),location.hostname,location.protocol,e?"safeframe":t?"sandboxed":n?"iframe":"normal"}function f(e){return e?e.replace(/\/+$/,""):""}function u(t){try{a()&&e.$sf.ext.message?e.$sf.ext.message(JSON.stringify(t),"*"):e.parent&&e.parent!==e&&e.parent.postMessage(t,"*")}catch(e){}}function p(n){var r=n&&n.retryCount||2,i=n&&n.retryDelays||t;return new Promise(function(t){var n=0;!function o(){n++,new Promise(function(t){var n=!1,r=setTimeout(function(){n||(n=!0,e.removeEventListener("message",i),t(null))},500);function i(o){if(!n){var a=o.data;if(a&&"MIV_FP_RESPONSE"===a.type){n=!0,clearTimeout(r),e.removeEventListener("message",i);var c={fingerprint:a.fingerprint||null,pageUrl:a.pageUrl||null};a.fingerprint,a.pageUrl,t(c)}}}e.addEventListener("message",i,!1),u({type:"MIV_FP_REQUEST"})}).then(function(e){if(e&&null!==e.fingerprint)t(e);else if(e&&null!==e.pageUrl)t(e);else if(n<r){var a=i[n-1]||2e3;setTimeout(o,a)}else t(null)})}()})}i.forPortal=function(e){var t=new i;return t._portalId=e,t},i.prototype.withCorrelationId=function(e){return this._correlationId=e,this},i.prototype.withPageUrl=function(e){return this._pageUrl=e,this},i.prototype.withMetadata=function(e){return this._metadata=e,this},i.prototype.withFingerprintServiceUrl=function(e){return this._fpServiceUrl=e,this},i.prototype.withBannerManagementUrl=function(e){return this._bmServiceUrl=e,this},i.prototype._getStoredFingerprint=function(){return null},i.prototype._storeFingerprint=function(e,t){return!0},i.prototype._fetchConfig=function(){return this._portalId&&this._fpServiceUrl?fetch(f(this._fpServiceUrl)+"/api/v1/config/"+this._portalId).then(function(e){if(!e.ok)throw new Error("Config fetch failed");return e.json()}).catch(function(e){return{collectors:["webgl","audio","css","media","speech","hardware","system"],enabled:!0,cookieMaxAge:r}}):Promise.resolve({collectors:["webgl","audio","css","media","speech","hardware","system"],enabled:!0,cookieMaxAge:r})};var d={webgl:"useWebGL",audio:"useAudio",css:"useCSS",media:"useMedia",speech:"useSpeech",hardware:"useHardware",system:"useSystem",devices:"useDevices",sensors:"useSensors",gamepad:"useGamepad",midi:"useMIDI"};i.prototype._collectRawData=function(e){var t="undefined"==typeof Fingerprint?null:"function"==typeof Fingerprint.builder?Fingerprint:Fingerprint.default&&"function"==typeof Fingerprint.default.builder?Fingerprint.default:Fingerprint.Fingerprint&&"function"==typeof Fingerprint.Fingerprint.builder?Fingerprint.Fingerprint:"function"==typeof Fingerprint.useAll?Fingerprint:Fingerprint.default&&"function"==typeof Fingerprint.default.useAll?Fingerprint.default:null;if(!t)return Promise.reject(new Error("Fingerprint library not loaded"));var n=t.builder();return e.forEach(function(e){var t=d[e.toLowerCase()];t&&"function"==typeof n[t]&&(n=n[t]())}),n.collect().then(function(e){return e.data})},i.prototype._generateHash=function(e){var t=function(e){try{return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}catch(i){if("undefined"!=typeof TextEncoder){for(var t=(new TextEncoder).encode(e),n="",r=0;r<t.length;r++)n+=String.fromCharCode(t[r]);return btoa(n)}throw i}}(JSON.stringify(e)),n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({portalId:this._portalId,data:t})};c()&&(n.credentials="include");var r=f(this._fpServiceUrl)+"/api/v1/generate";return n.credentials,fetch(r,n).then(function(e){if(e.status,e.ok,!e.ok)throw new Error("Failed to generate fingerprint");return e.json()}).then(function(e){return e}).catch(function(e){throw e.message,e})},i.prototype._sendToBannerManagement=function(t){if(this._correlationId,this._bmServiceUrl&&this._correlationId){var n,r=function(){try{if(e.top&&e.top!==e&&e.top.location&&e.top.location.href)return e.top.location.href}catch(e){}return null}();this._parentPageUrl,this._pageUrl,document.referrer,e.location.href,n=a(r)?r:a(this._parentPageUrl)?this._parentPageUrl:a(this._pageUrl)?this._pageUrl:a(document.referrer)||document.referrer&&0===document.referrer.indexOf("http")?document.referrer:e.location.href;var i={correlation_id:this._correlationId,fingerprint:t,page_url:n,timestamp:(new Date).toISOString(),metadata:this._metadata},o=f(this._bmServiceUrl)+"/api/v1/fingerprints";fetch(o,{method:"POST",body:JSON.stringify(i),headers:{"Content-Type":"text/plain"},credentials:"include",keepalive:!0}).then(function(e){e.status,e.ok}).catch(function(e){e.message})}function a(t){return!!t&&0!==t.indexOf("about:")&&-1===t.indexOf("track.mediaintelliview.com")&&-1===t.indexOf("fp.mediaintelliview.com")&&-1===t.indexOf("/api/v1/banners/deliver")&&-1===t.indexOf("googlesyndication.com")&&-1===t.indexOf("doubleclick.net")&&-1===t.indexOf("admaxium.com")&&t!==e.location.href}},i.prototype._sendMetadataOnly=function(){if(this._correlationId,this._bmServiceUrl&&this._correlationId){var t,n=function(){try{if(e.top&&e.top!==e&&e.top.location&&e.top.location.href)return e.top.location.href}catch(e){}return null}();t=o(n)?n:o(this._parentPageUrl)?this._parentPageUrl:o(this._pageUrl)?this._pageUrl:o(document.referrer)||document.referrer&&0===document.referrer.indexOf("http")?document.referrer:e.location.href;var r={correlation_id:this._correlationId,fingerprint:null,page_url:t,timestamp:(new Date).toISOString(),metadata:this._metadata,metadata_only:!0},i=f(this._bmServiceUrl)+"/api/v1/fingerprints";fetch(i,{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"text/plain"},credentials:"include",keepalive:!0}).then(function(e){e.status,e.ok}).catch(function(e){e.message})}function o(t){return!!t&&0!==t.indexOf("about:")&&-1===t.indexOf("track.mediaintelliview.com")&&-1===t.indexOf("fp.mediaintelliview.com")&&-1===t.indexOf("/api/v1/banners/deliver")&&-1===t.indexOf("googlesyndication.com")&&-1===t.indexOf("doubleclick.net")&&-1===t.indexOf("admaxium.com")&&t!==e.location.href}},i.prototype._collectNormal=function(){var t=this,n=o()?p().then(function(n){n&&n.pageUrl&&(t._parentPageUrl=n.pageUrl,e.__MIV_PAGE_URL__=n.pageUrl,n.pageUrl)}).catch(function(){}):Promise.resolve();return Promise.all([n,this._fetchConfig()]).then(function(e){var n=e[1];return n.enabled?t._collectRawData(n.collectors).then(function(e){return Object.keys(e),t._generateHash(e)}).then(function(e){return t._sendToBannerManagement(e.fingerprint),{fingerprint:e.fingerprint,confidence:e.confidence,cached:!1,source:"server",context:"normal"}}):{fingerprint:null,disabled:!0}}).catch(function(e){throw e.message,e})},i.prototype._collectViaBridge=function(){var t=this;return p().then(function(n){var i=n?n.fingerprint:null,o=n?n.pageUrl:null;return o&&(t._parentPageUrl=o,e.__MIV_PAGE_URL__=o),i?(t._sendToBannerManagement(i),{fingerprint:i,cached:!0,source:"parent",context:"bridge"}):t._fetchConfig().then(function(e){return e.enabled?t._collectRawData(e.collectors).then(function(e){return t._generateHash(e)}).then(function(e){var n=e.expiresIn||r;return function(e,t){u({type:"MIV_FP_STORE",fingerprint:e,maxAge:t||r})}(e.fingerprint,n),t._sendToBannerManagement(e.fingerprint),{fingerprint:e.fingerprint,confidence:e.confidence,cached:!1,source:"parent",context:"bridge"}}):{fingerprint:null,disabled:!0}})})},i.prototype._collectFallback=function(){var e=this;return this._fetchConfig().then(function(t){return t.enabled?e._collectRawData(t.collectors).then(function(t){return e._generateHash(t)}).then(function(t){return e._sendToBannerManagement(t.fingerprint),{fingerprint:t.fingerprint,confidence:t.confidence,cached:!1,source:"none",context:"fallback"}}):{fingerprint:null,disabled:!0}})},i.prototype.collect=function(){var t,r,i=this;if(this._portalId,this._correlationId,this._fpServiceUrl,this._bmServiceUrl,!0===e.__MIV_FP_COLLECTED__)return i=this,"sandboxed"===(r=s())||"safeframe"===r||"iframe"===r?p({retryCount:5,retryDelays:n}).then(function(t){return t&&t.pageUrl&&(i._parentPageUrl=t.pageUrl,e.__MIV_PAGE_URL__=t.pageUrl,t.pageUrl),i._sendMetadataOnly(),{fingerprint:null,skipped:!1,reason:"metadata_only",context:r}}).catch(function(e){return e.message,i._sendMetadataOnly(),{fingerprint:null,skipped:!1,reason:"metadata_only",context:"fallback"}}):(this._sendMetadataOnly(),Promise.resolve({fingerprint:null,skipped:!1,reason:"metadata_only",context:"server_flag"}));switch(r=s()){case"normal":case"iframe":t=this._collectNormal();break;case"sandboxed":case"safeframe":t=this._collectViaBridge().catch(function(e){return e.message,i._collectFallback()});break;default:t=this._collectViaBridge().catch(function(e){return i._collectFallback()})}return t.then(function(e){return e}).catch(function(e){throw e.message,e})},e.FingerprintClient=i}(window);